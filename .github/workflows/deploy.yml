name: Deploy

on:
  workflow_call:
    inputs:
      app-version:
        required: true
        type: string
      distribution-channel:
        required: true
        type: string

permissions:
  contents: write

defaults:
  run:
    shell: 'bash'

env:
  NODE_NO_WARNINGS: 1
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
  npm_config_audit: false
  npm_config_fund: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{inputs.distribution-channel}}
      url: https://github.com/${{github.repository}}/releases/tag/v${{inputs.app-version}}
    steps:
      - name: Download compiled app
        uses: actions/download-artifact@v5
        with:
          pattern: "*-${{inputs.distribution-channel}}"
          path: dist
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "Files in dist root:"
          ls -lh dist/ | head -20 || true
          echo ""
          echo "Looking for release artifacts..."

      - name: Create GitHub Release
        run: |
          # Chỉ tìm files ở root level của dist (không tìm sâu vào app bundles)
          # Tìm các installer files và update files
          # Sử dụng while read để handle filenames có khoảng trắng
          RELEASE_FILES=()
          
          # Windows: .exe installer
          while IFS= read -r -d '' file; do
            RELEASE_FILES+=("$file")
          done < <(find dist -maxdepth 1 -name "*.exe" -type f -print0)
          
          # macOS: .dmg
          while IFS= read -r -d '' file; do
            RELEASE_FILES+=("$file")
          done < <(find dist -maxdepth 1 -name "*.dmg" -type f -print0)
          
          # Linux: .deb, .AppImage
          while IFS= read -r -d '' file; do
            RELEASE_FILES+=("$file")
          done < <(find dist -maxdepth 1 -name "*.deb" -type f -print0)
          
          while IFS= read -r -d '' file; do
            RELEASE_FILES+=("$file")
          done < <(find dist -maxdepth 1 -name "*.AppImage" -type f -print0)
          
          # Update files: .yml, .sig
          while IFS= read -r -d '' file; do
            RELEASE_FILES+=("$file")
          done < <(find dist -maxdepth 1 -name "*.yml" -type f -print0)
          
          while IFS= read -r -d '' file; do
            RELEASE_FILES+=("$file")
          done < <(find dist -maxdepth 1 -name "*.sig" -type f -print0)
          
          if [ ${#RELEASE_FILES[@]} -eq 0 ]; then
            echo "No release files found!"
            echo "Contents of dist:"
            ls -la dist/ || true
            exit 1
          fi
          
          echo "Found ${#RELEASE_FILES[@]} files to upload:"
          printf '%s\n' "${RELEASE_FILES[@]}"
          
          # Pass files với quotes để handle spaces trong filenames
          gh release create v${{inputs.app-version}} "${RELEASE_FILES[@]}" \
            --repo ${{github.repository}} \
            --title "v${{inputs.app-version}}" \
            --notes "Release v${{inputs.app-version}}"
        env:
          GH_TOKEN: ${{ github.token }}
